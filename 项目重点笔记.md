# 项目重点笔记

## 核心工作流程：数据更新

0.  **环境准备**: 首次或在全新环境中操作时，必须先安装 `python-calamine` 库 (`pip install python-calamine`)，以启用最健壮的 Excel 解析引擎。

1.  **数据源**: 数据源是用户**本地电脑**上的 `excel_data` 文件夹里的 Excel 文件。这些文件**不会**上传到 GitHub。

2.  **操作方式**: 用户在**本地电脑**上运行 `flask import-data` 命令。

3.  **连接目标**: 该命令通过 `.env` 文件中的 `DATABASE_URL` 连接到 **Render 上的生产数据库**。

4.  **命令作用**: 该命令会**清空**`Booking`和`Expense`表中的所有旧数据，然后从本地 Excel 文件中导入新数据。**此操作不会触碰 `User` 表，用户账户和密码是安全的。**

5.  **最终目的**: 将本地 Excel 数据**更新**到远程生产数据库，同时保持用户数据不变。

## **极其重要的规则：如何修改文件**

**绝对禁止使用 `replace` 工具！**

此工具已多次因处理特殊字符失败而导致代码行被截断，引发致命的语法错误和部署失败。

**必须始终使用 `write_file` 工具来修改文件。**

正确修改流程如下：

1.  使用 `read_file` 读取要修改的**完整文件内容**。
2.  在内存中对完整的代码内容进行修改。
3.  使用 `write_file` 将**修改后的完整内容**一次性覆盖写回原文件。

## 需要记住的代码逻辑

-   **最终的、真正的根本原因 (The True Root Cause)**: **数据本身的人为错误**。一个看似正常的 `03_2023 expenses.xlsx` 文件，其内部的日期数据被错误地输成了 `2024` 年。这导致数据被正确地导入了数据库的**错误年份**中，使得在查询正确年份时无法找到数据。这是最隐蔽、最难通过代码逻辑排查，但却最常见的问题。**永远要相信用户的观察，并优先怀疑数据本身。**

-   **次要的技术原因**: 某些 `.xlsx` 文件可能包含特殊的、肉眼不可见的格式，导致默认的 `openpyxl` 引擎解析失败。

-   **最终的技术解决方案**: 将 `pandas.read_excel` 的解析引擎更换为 `engine='calamine'`。这是一个更现代、更健壮的引擎，能提高对各种 Excel 文件的兼容性。

-   **密码重置问题修复**: `flask import-data` 命令**绝不能**使用 `db.drop_all()`。正确的做法是只针对特定数据模型执行删除操作，例如 `db.session.query(Booking).delete()`，以保证用户表的安全。

-   **文件匹配规则**: 使用 `*expenses*.xlsx` 来匹配费用文��，以兼容文件名中包含空格的情况。

-   **列名兼容性**: 脚本通过健壮的逻辑，能够兼容 `DEBIT` 和 `Amount` 等不同的列名。

-   **Pandas代码优化**: 为避免 `FutureWarning`，使用 `df[col] = df[col].fillna(value)` 的写法，而不是 `df[col].fillna(value, inplace=True)`。

## 部署问题排查记录 (2025-08-15)

### 数据库连接问题

-   **症状**: 网站随机出现 `SSL connection has been closed unexpectedly` 错误，导致页面无法访问。
-   **根本原因**: Render 平台的数据库在闲置一段时间后会自动休眠，导致应用持有的数据库连接失效。
-   **解决方案**: 修改 `config.py` 文件，添加 `SQLALCHEMY_ENGINE_OPTIONS = {'pool_pre_ping': True}` 配置。这会使 SQLAlchemy 在每次使用连接前都进行一次“心跳”检测，如果连接已断开则自动重连。

### Docker 构建失败问题 (wkhtmltopdf)

-   **症状**: 推送代码后，在 Render 上的部署构建环节失败，报错 `Package 'wkhtmltopdf' has no installation candidate` 或 `exit code: 1, 2, 127`。
-   **根本原因**: Render 更新了其用于构建的 Docker 基础镜像 (`python:3.9-slim`)。新镜像的底层操作系统（如 Debian 11/12）的官方软件源中不再包含 `wkhtmltopdf` 这个包，导致 `apt-get install` 失败。后续尝试下载 `.deb` 包安装也因环境兼容性、依赖缺失或工具链不完整等原因失败。
-   **最终解决方案**: 修改 `Dockerfile`，采用最健壮的手动安装方法：
    1.  通过 `apt-get` 安装基础工具链 (`curl`, `binutils`, `xz-utils`, `file`) 和中文字体。
    2.  使用 `curl` 从 `wkhtmltopdf` 官方 GitHub 下载一个已知兼容的 `.deb` 包（例如 `bullseye` 版本）。
    3.  **不使用 `dpkg` 安装**，而是用 `ar x` 和 `tar -xvf` 命令手动解压 `.deb` 包和其中的 `data.tar.xz` 文件。
    4.  将解压出来的 `wkhtmltopdf` 和 `wkhtmltoimage` 两个核心可执行文件直接复制到系统路径 `/usr/local/bin/` 下。
    5.  清理所有下载和解压的临时文件。
-   **结论**: 此方法完全绕过了操作系统的包管理器和依赖检查，直接安装预编译的二进制文件，可以最大限度地抵抗未来基础环境的变更，确保部署的稳定性。
