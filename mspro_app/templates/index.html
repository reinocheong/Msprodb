<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>民宿财务概览</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&family=Open+Sans:wght@300;400;600&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
</head>
<body class="bg-light">
    <div id="loadingOverlay" class="loading-overlay show">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <div class="loading-text">加载中...</div>
    </div>

    <div class="container-fluid">
        <nav class="navbar navbar-expand-lg navbar-dark bg-success mb-4 rounded-3 shadow-sm">
            <div class="container">
                <a class="navbar-brand" href="{{ url_for('main.index') }}">
                    <i class="fas fa-home me-2"></i>民宿财务概览
                </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav ms-auto">
                        <li class="nav-item">
                            <span class="nav-link">欢迎, {{ current_user.id }}!</span>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('main.logout') }}">
                                <i class="fas fa-sign-out-alt me-1"></i>退出
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>

        <h1 class="text-center mb-5 text-success display-4 fw-bold">民宿财务概览</h1>

        <section class="card shadow-sm mb-5 p-4 bg-light-subtle">
            <div class="card-body">
                <h2 class="card-title text-center mb-4 text-secondary"><i class="fas fa-filter me-2"></i>筛选条件</h2>
                <div class="row g-3 align-items-end justify-content-center">
                    <div class="col-md-3">
                        <label for="yearSelect" class="form-label"><i class="fas fa-calendar-alt me-2"></i>年份:</label>
                        <select id="yearSelect" class="form-select">
                            {% for year in years_options %}
                                <option value="{{ year }}" {% if year|string == default_year %}selected{% endif %}>{{ year }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="col-md-3">
                        <label for="monthSelect" class="form-label"><i class="fas fa-calendar-check me-2"></i>月份:</label>
                        <select id="monthSelect" class="form-select">
                            <option value="">所有月份</option>
                            {% for month in months_options %}
                                <option value="{{ month.value }}">{{ month.text }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="col-md-3">
                        <label for="roomTypeSelect" class="form-label"><i class="fas fa-bed me-2"></i>房型:</label>
                        <select id="roomTypeSelect" class="form-select">
                            {% for room_type in room_types %}
                                <option value="{{ room_type }}">{{ room_type }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="col-md-3 d-grid">
                        <button id="applyFiltersButton" class="btn btn-primary">
                            <i class="fas fa-filter me-2"></i>应用筛选
                        </button>
                    </div>
                </div>
                <div class="row g-3 justify-content-center mt-3">
                    <div class="col-md-4 d-grid">
                        <button id="toggleDetailedRecordsButton" class="btn btn-outline-secondary">
                            <i class="fas fa-eye me-2"></i>查看详细
                        </button>
                    </div>
                    <div class="col-md-4 d-grid">
                        <button id="downloadPdfButton" class="btn btn-outline-info">
                            <i class="fas fa-download me-2"></i>下载月结单
                        </button>
                    </div>
                    {% if current_user.role == 'admin' %}
                    <div class="col-md-4 d-grid">
                        <a href="{{ url_for('main.add_booking') }}" class="btn btn-success">
                            <i class="fas fa-plus-circle me-2"></i>新增预订
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </section>

        <section class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4 mb-5 summary-cards">
            <div class="col">
                <div class="card h-100 shadow-sm revenue" data-card-type="revenue">
                    <div class="card-body text-center">
                        <h5 class="card-title text-muted"><i class="fas fa-hand-holding-usd me-2"></i>预订收入</h5>
                        <p id="totalBookingRevenue" class="card-text">0.00</p>
                    </div>
                </div>
            </div>
            <div class="col">
                <div class="card h-100 shadow-sm expenses" data-card-type="expenses">
                    <div class="card-body text-center">
                        <h5 class="card-title text-muted"><i class="fas fa-money-bill-wave me-2"></i>月支出</h5>
                        <p id="totalMonthlyExpenses" class="card-text">0.00</p>
                    </div>
                </div>
            </div>
            <div class="col">
                <div class="card h-100 shadow-sm profit" data-card-type="profit">
                    <div class="card-body text-center">
                        <h5 class="card-title text-muted"><i class="fas fa-chart-line me-2"></i>毛利</h5>
                        <p id="grossProfit" class="card-text">0.00</p>
                    </div>
                </div>
            </div>
            <div class="col">
                <div class="card h-100 shadow-sm fee" data-card-type="fee">
                    <div class="card-body text-center">
                        <h5 class="card-title text-muted"><i class="fas fa-percent me-2"></i>管理费 (30%)</h5>
                        <p id="managementFee" class="card-text">0.00</p>
                    </div>
                </div>
            </div>
            <div class="col">
                <div class="card h-100 shadow-sm income" data-card-type="income">
                    <div class="card-body text-center">
                        <h5 class="card-title text-muted"><i class="fas fa-piggy-bank me-2"></i>当月收入</h5>
                        <p id="monthlyIncome" class="card-text">0.00</p>
                    </div>
                </div>
            </div>
            <div class="col">
                <div class="card h-100 shadow-sm occupancy" data-card-type="occupancy">
                    <div class="card-body text-center">
                        <h5 class="card-title text-muted"><i class="fas fa-bed me-2"></i>入住率</h5>
                        <p id="totalOccupancyRate" class="card-text">0.00%</p>
                    </div>
                </div>
            </div>
        </section>

        <section id="annualAnalysisSection" class="card shadow-sm mb-5 p-4 bg-light-subtle" style="display: none;">
            <!-- Content will be populated by JavaScript -->
        </section>

        <section class="card shadow-sm mb-5 p-4">
            <div class="card-body">
                <h2 class="card-title text-center mb-4 text-secondary"><i class="fas fa-chart-area me-2"></i>月度收支概览</h2>
                <canvas id="monthlyChart" class="w-100" style="max-height: 400px;"></canvas>
            </div>
        </section>

        <section class="card shadow-sm mb-5 p-4" id="detailedRecordsSection" style="display: none;">
            <div class="card-body">
                <h2 class="card-title text-center mb-4 text-secondary"><i class="fas fa-table me-2"></i>详细记录</h2>
                <div class="table-responsive">
                    <table class="table table-hover table-bordered">
                        <thead>
                            <tr>
                                <th>预订号</th><th>日期</th><th>类型</th><th>房型</th><th>入住日期</th><th>退房日期</th>
                                <th>渠道</th><th>在线/离线</th><th>人数</th><th>天数</th><th>价格</th><th>打扫费</th>
                                <th>平台费</th><th>总收入</th><th>额外支出类别</th><th>额外支出金额</th>
                                {% if current_user.role == 'admin' %}<th>操作</th>{% endif %}
                            </tr>
                        </thead>
                        <tbody id="dataRows"></tbody>
                    </table>
                </div>
            </div>
        </section>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script>
        const loadingOverlay = document.getElementById('loadingOverlay');
        let monthlyChart;

        function showLoading() { loadingOverlay.classList.add('show'); }
        function hideLoading() { loadingOverlay.classList.remove('show'); }

        async function fetchData(endpoint, params) {
            const queryParams = new URLSearchParams(params).toString();
            try {
                const response = await fetch(`${endpoint}?${queryParams}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error(`Error fetching from ${endpoint}:`, error);
                alert('加载数据失败。请检查网络连接或后端服务器日志。');
                return null;
            }
        }

        function updateSummary(summary) {
            if (!summary) return;
            document.getElementById('totalBookingRevenue').innerText = (summary.total_booking_revenue || 0).toFixed(2);
            document.getElementById('totalMonthlyExpenses').innerText = (summary.total_monthly_expenses || 0).toFixed(2);
            document.getElementById('grossProfit').innerText = (summary.gross_profit || 0).toFixed(2);
            document.getElementById('managementFee').innerText = (summary.management_fee || 0).toFixed(2);
            document.getElementById('monthlyIncome').innerText = (summary.monthly_income || 0).toFixed(2);
            document.getElementById('totalOccupancyRate').innerText = (summary.total_occupancy_rate || 0).toFixed(2) + '%';
        }

        function updateDetailedRecords(data) {
            const dataRows = document.getElementById('dataRows');
            dataRows.innerHTML = '';
            if (!data || data.length === 0) {
                const colspan = "{{ current_user.role }}" === 'admin' ? 17 : 16;
                dataRows.innerHTML = `<tr><td colspan="${colspan}" class="text-center text-muted">没有数据可显示。</td></tr>`;
                return;
            }

            data.forEach(record => {
                const row = document.createElement('tr');
                let editButtonHtml = '';
                if ("{{ current_user.role }}" === 'admin') {
                    let url = '';
                    if (record.type === 'booking' && record.booking_number) {
                        url = `/edit_booking/${record.booking_number}?next=${encodeURIComponent(window.location.href)}`;
                    } else if (record.type === 'expense' && record.expense_id) {
                        url = `/edit_expense/${record.expense_id}?next=${encodeURIComponent(window.location.href)}`;
                    }
                    if(url) editButtonHtml = `<td><a href="${url}" class="btn btn-sm btn-warning">编辑</a></td>`;
                    else editButtonHtml = '<td>-</td>';
                }

                row.innerHTML = `
                    <td>${record.booking_number || '-'}</td>
                    <td>${record.date}</td>
                    <td><span class="badge ${record.type === 'booking' ? 'bg-success' : 'bg-danger'}">${record.type === 'booking' ? '预订' : '支出'}</span></td>
                    <td>${record.unit_name || '通用'}</td>
                    <td>${record.checkin || '-'}</td>
                    <td>${record.checkout || '-'}</td>
                    <td>${record.channel || '-'}</td>
                    <td>${record.on_offline || '-'}</td>
                    <td class="text-center">${record.pax || '-'}</td>
                    <td class="text-center">${record.duration || '-'}</td>
                    <td class="text-end">${(record.price || 0).toFixed(2)}</td>
                    <td class="text-end">${(record.cleaning_fee || 0).toFixed(2)}</td>
                    <td class="text-end">${(record.platform_charge || 0).toFixed(2)}</td>
                    <td class="text-end">${(record.total_booking_revenue || 0).toFixed(2)}</td>
                    <td>${record.additional_expense_category || '-'}</td>
                    <td class="text-end">${(record.additional_expense_amount || 0).toFixed(2)}</td>
                    ${editButtonHtml}
                `;
                dataRows.appendChild(row);
            });
        }

        async function applyFilters() {
            showLoading();
            const year = document.getElementById('yearSelect').value;
            const month = document.getElementById('monthSelect').value;
            const roomType = document.getElementById('roomTypeSelect').value;
            const params = { year, month, room_type: roomType };

            const result = await fetchData('/api/filter_data', params);
            if (result) {
                updateSummary(result.summary);
                // updateAnalysis(result.analysis); // This can be added back if needed
            }
            
            document.getElementById('detailedRecordsSection').style.display = 'none';
            document.getElementById('toggleDetailedRecordsButton').innerHTML = '<i class="fas fa-eye me-2"></i>查看详细';
            
            await fetchChartData(year, roomType);
            hideLoading();
        }

        async function fetchChartData(year, roomType) {
            const chartData = await fetchData('/api/chart_data', { year, room_type: roomType, month: '' });
            if (!chartData) return;

            if (monthlyChart) monthlyChart.destroy();
            const ctx = document.getElementById('monthlyChart').getContext('2d');
            monthlyChart = new Chart(ctx, { /* ... Chart.js options ... */ });
        }

        document.addEventListener('DOMContentLoaded', function() {
            Chart.register(ChartDataLabels);
            applyFilters();

            document.getElementById('applyFiltersButton').addEventListener('click', applyFilters);
            
            document.getElementById('toggleDetailedRecordsButton').addEventListener('click', async () => {
                const section = document.getElementById('detailedRecordsSection');
                const button = document.getElementById('toggleDetailedRecordsButton');
                if (section.style.display === 'none') {
                    showLoading();
                    const year = document.getElementById('yearSelect').value;
                    const month = document.getElementById('monthSelect').value;
                    const roomType = document.getElementById('roomTypeSelect').value;
                    const result = await fetchData('/api/detailed_data', { year, month, room_type: roomType });
                    if (result) {
                        updateDetailedRecords(result.data);
                        section.style.display = 'block';
                        button.innerHTML = '<i class="fas fa-eye-slash me-2"></i>隐藏详细';
                    }
                    hideLoading();
                } else {
                    section.style.display = 'none';
                    button.innerHTML = '<i class="fas fa-eye me-2"></i>查看详细';
                }
            });

            document.getElementById('downloadPdfButton').addEventListener('click', () => {
                const year = document.getElementById('yearSelect').value;
                const month = document.getElementById('monthSelect').value;
                if (!month) {
                    alert('请选择一个具体的月份来下载月结单。');
                    return;
                }
                const roomType = document.getElementById('roomTypeSelect').value;
                const queryParams = new URLSearchParams({ year, month, room_type: roomType }).toString();
                window.location.href = `/download_monthly_statement?${queryParams}`;
            });
        });
    </script>
</body>
</html>