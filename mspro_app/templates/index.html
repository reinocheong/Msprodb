<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>民宿财务概览</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body class="bg-light">
    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div>
    </div>

    <div class="container-fluid">
        <nav class="navbar navbar-expand-lg navbar-dark bg-success mb-4 rounded-3 shadow-sm">
            <div class="container">
                <a class="navbar-brand" href="{{ url_for('main.index') }}"><i class="fas fa-home me-2"></i>民宿财务概览</a>
                <div class="collapse navbar-collapse">
                    <ul class="navbar-nav ms-auto">
                        <li class="nav-item"><span class="nav-link">欢迎, {{ current_user.id }}!</span></li>
                        <li class="nav-item"><a class="nav-link" href="{{ url_for('main.logout') }}"><i class="fas fa-sign-out-alt me-1"></i>退出</a></li>
                    </ul>
                </div>
            </div>
        </nav>

        <h1 class="text-center mb-5 text-success display-4 fw-bold">民宿财务概览</h1>

        <section class="card shadow-sm mb-5 p-4 bg-light-subtle">
            <div class="card-body">
                <h2 class="card-title text-center mb-4 text-secondary"><i class="fas fa-filter me-2"></i>筛选条件</h2>
                <div class="row g-3 align-items-end justify-content-center">
                    <div class="col-md-3"><label for="yearSelect" class="form-label">年份:</label><select id="yearSelect" class="form-select">{% for year in years_options %}<option value="{{ year }}" {% if year|string == default_year %}selected{% endif %}>{{ year }}</option>{% endfor %}</select></div>
                    <div class="col-md-3"><label for="monthSelect" class="form-label">月份:</label><select id="monthSelect" class="form-select"><option value="">所有月份</option>{% for month in months_options %}<option value="{{ month.value }}">{{ month.text }}</option>{% endfor %}</select></div>
                    <div class="col-md-3"><label for="roomTypeSelect" class="form-label">房型:</label><select id="roomTypeSelect" class="form-select">{% for room_type in room_types %}<option value="{{ room_type }}">{{ room_type }}</option>{% endfor %}</select></div>
                    <div class="col-md-3 d-grid"><button id="applyFiltersButton" class="btn btn-primary"><i class="fas fa-filter me-2"></i>应用筛选</button></div>
                </div>
                <div class="row g-3 justify-content-center mt-3">
                    <div class="col-md-4 d-grid"><button id="toggleDetailedRecordsButton" class="btn btn-outline-secondary"><i class="fas fa-eye me-2"></i>查看详细</button></div>
                    <div class="col-md-4 d-grid"><button id="downloadPdfButton" class="btn btn-outline-info"><i class="fas fa-download me-2"></i>下载月结单</button></div>
                    {% if current_user.role == 'admin' %}<div class="col-md-4 d-grid"><a href="{{ url_for('main.add_booking') }}" class="btn btn-success"><i class="fas fa-plus-circle me-2"></i>新增预订</a></div>{% endif %}
                </div>
            </div>
        </section>

        <section class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4 mb-5 summary-cards">
            <div class="col"><div class="card h-100 shadow-sm" data-card-type="revenue"><div class="card-body text-center"><h5 class="card-title text-muted">预订收入</h5><p id="totalBookingRevenue" class="card-text">0.00</p></div></div></div>
            <div class="col"><div class="card h-100 shadow-sm" data-card-type="expenses"><div class="card-body text-center"><h5 class="card-title text-muted">月支出</h5><p id="totalMonthlyExpenses" class="card-text">0.00</p></div></div></div>
            <div class="col"><div class="card h-100 shadow-sm" data-card-type="profit"><div class="card-body text-center"><h5 class="card-title text-muted">毛利</h5><p id="grossProfit" class="card-text">0.00</p></div></div></div>
            <div class="col"><div class="card h-100 shadow-sm" data-card-type="fee"><div class="card-body text-center"><h5 class="card-title text-muted">管理费 (30%)</h5><p id="managementFee" class="card-text">0.00</p></div></div></div>
            <div class="col"><div class="card h-100 shadow-sm" data-card-type="income"><div class="card-body text-center"><h5 class="card-title text-muted">当月收入</h5><p id="monthlyIncome" class="card-text">0.00</p></div></div></div>
            <div class="col"><div class="card h-100 shadow-sm" data-card-type="occupancy"><div class="card-body text-center"><h5 class="card-title text-muted">入住率</h5><p id="totalOccupancyRate" class="card-text">0.00%</p></div></div></div>
        </section>

        <section class="card shadow-sm mb-5 p-4"><div class="card-body"><h2 class="card-title text-center mb-4 text-secondary">月度收支概览</h2><canvas id="monthlyChart" class="w-100" style="max-height: 400px;"></canvas></div></section>

        <section class="card shadow-sm mb-5 p-4" id="detailedRecordsSection" style="display: none;"><div class="card-body"><h2 class="card-title text-center mb-4 text-secondary">详细记录</h2><div class="table-responsive"><table class="table table-hover table-bordered"><thead><tr><th>预订号</th><th>日期</th><th>类型</th><th>房型</th><th>入住日期</th><th>退房日期</th><th>渠道</th><th>在���/离线</th><th>人数</th><th>天数</th><th>价格</th><th>打扫费</th><th>平台费</th><th>总收入</th><th>额外支出类别</th><th>额外支出金额</th>{% if current_user.role == 'admin' %}<th>操作</th>{% endif %}</tr></thead><tbody id="dataRows"></tbody></table></div></div></section>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const loadingOverlay = document.getElementById('loading-overlay');
            loadingOverlay.style.display = 'flex'; // 显示加载动画

            const summaryPromise = fetch('/api/summary').then(response => {
                if (!response.ok) throw new Error('Network response was not ok for summary.');
                return response.json();
            });
            const monthlyRevenuePromise = fetch('/api/monthly-revenue').then(response => {
                if (!response.ok) throw new Error('Network response was not ok for monthly revenue.');
                return response.json();
            });

            Promise.all([summaryPromise, monthlyRevenuePromise])
                .then(([summaryData, monthlyRevenueData]) => {
                    // 更新总览数据
                    document.getElementById('total-revenue').textContent = `${summaryData.total_revenue.toLocaleString()}`;
                    document.getElementById('total-bookings').textContent = summaryData.total_bookings.toLocaleString();
                    document.getElementById('average-booking-value').textContent = `${summaryData.average_booking_value.toLocaleString()}`;
                    document.getElementById('total-expenses').textContent = `${summaryData.total_expenses.toLocaleString()}`;
                    document.getElementById('net-income').textContent = `${summaryData.net_income.toLocaleString()}`;

                    // 渲染图表
                    var ctx = document.getElementById('myChart').getContext('2d');
                    var gradient = ctx.createLinearGradient(0, 0, 0, 400);
                    gradient.addColorStop(0, 'rgba(75, 192, 192, 0.6)');
                    gradient.addColorStop(1, 'rgba(75, 192, 192, 0.1)');

                    var myChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: monthlyRevenueData.labels,
                            datasets: [{
                                label: '月度总收入',
                                data: monthlyRevenueData.values,
                                backgroundColor: gradient, // 恢复渐变背景
                                borderColor: 'rgba(75, 192, 192, 1)',
                                borderWidth: 1,
                                hoverBackgroundColor: 'rgba(75, 192, 192, 0.8)'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        callback: function(value, index, values) {
                                            return 'RM ' + value.toLocaleString();
                                        }
                                    }
                                }
                            },
                            plugins: {
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            let label = context.dataset.label || '';
                                            if (label) {
                                                label += ': ';
                                            }
                                            if (context.parsed.y !== null) {
                                                label += 'RM ' + context.parsed.y.toLocaleString();
                                            }
                                            return label;
                                        }
                                    }
                                }
                            }
                        }
                    });
                })
                .catch(error => {
                    console.error('Error fetching data:', error);
                    // 在页面上显示一个错误提示
                    const container = document.querySelector('.container-fluid');
                    if(container) {
                        const errorDiv = document.createElement('div');
                        errorDiv.className = 'alert alert-danger';
                        errorDiv.textContent = '数据加载失败，请稍后重试。';
                        container.prepend(errorDiv);
                    }
                })
                .finally(() => {
                    // 确保加载动画总是被隐藏
                    loadingOverlay.style.display = 'none';
                });
        });
    </script>
</body>
</html>