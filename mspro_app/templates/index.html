{% extends "base.html" %}
{% block title %}财务与数据分析仪表盘{% endblock %}

{% block content %}
<section class="card shadow-sm mb-5 p-4 bg-light-subtle">
    <div class="card-body">
        <h2 class="card-title text-center mb-4 text-secondary"><i class="fas fa-filter me-2"></i>筛选条件</h2>
        <div class="row g-3 align-items-end justify-content-center">
            <div class="col-md-3"><label for="yearSelect" class="form-label">主年份:</label><select id="yearSelect" class="form-select">{% for year in years_options %}<option value="{{ year }}" {% if year|string == default_year %}selected{% endif %}>{{ year }}</option>{% endfor %}</select></div>
            <div class="col-md-3"><label for="compareYearSelect" class="form-label">对比年份 (可选):</label><select id="compareYearSelect" class="form-select"><option value="">无</option>{% for year in years_options %}<option value="{{ year }}">{{ year }}</option>{% endfor %}</select></div>
            <div class="col-md-3"><label for="roomTypeSelect" class="form-label">房型:</label><select id="roomTypeSelect" class="form-select">{% for room_type in room_types %}<option value="{{ room_type }}">{{ room_type }}</option>{% endfor %}</select></div>
            <div class="col-md-3 d-grid"><button id="applyFiltersButton" class="btn btn-primary"><i class="fas fa-sync-alt me-2"></i>更新仪表盘</button></div>
        </div>
        <div class="row g-3 justify-content-center mt-3">
            <div class="col-md-4 d-grid"><button id="toggleDetailedRecordsButton" class="btn btn-outline-secondary"><i class="fas fa-eye me-2"></i>查看详细</button></div>
            <div class="col-md-4 d-grid"><button id="downloadPdfButton" class="btn btn-outline-info"><i class="fas fa-download me-2"></i>下载月结单</button></div>
        </div>
    </div>
</section>

<section class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4 mb-5 summary-cards">
    <div class="col"><div class="card h-100 shadow-sm"><div class="card-body text-center"><h5 class="card-title text-muted">预订收入</h5><p id="totalBookingRevenue" class="card-text display-6">0.00</p></div></div></div>
    <div class="col"><div class="card h-100 shadow-sm"><div class="card-body text-center"><h5 class="card-title text-muted">月支出</h5><p id="totalMonthlyExpenses" class="card-text display-6">0.00</p></div></div></div>
    <div class="col"><div class="card h-100 shadow-sm"><div class="card-body text-center"><h5 class="card-title text-muted">毛利</h5><p id="grossProfit" class="card-text display-6">0.00</p></div></div></div>
    <div class="col"><div class="card h-100 shadow-sm"><div class="card-body text-center"><h5 class="card-title text-muted">管理费 (30%)</h5><p id="managementFee" class="card-text display-6">0.00</p></div></div></div>
    <div class="col"><div class="card h-100 shadow-sm"><div class="card-body text-center"><h5 class="card-title text-muted">当月收入</h5><p id="monthlyIncome" class="card-text display-6">0.00</p></div></div></div>
    <div class="col"><div class="card h-100 shadow-sm"><div class="card-body text-center"><h5 class="card-title text-muted">入住率</h5><p id="totalOccupancyRate" class="card-text display-6">0.00%</p></div></div></div>
</section>

<section class="card shadow-sm mb-5 p-4"><div class="card-body"><h2 class="card-title text-center mb-4 text-secondary">数据对比图</h2><canvas id="comparisonChart" class="w-100" style="max-height: 400px;"></canvas></div></section>

<section class="row g-4 mb-5">
    <div class="col-lg-6">
        <div class="card shadow-sm h-100 p-4">
            <div class="card-body"><h2 class="card-title text-center mb-4 text-secondary">渠道来源分析 (按年收入)</h2><canvas id="channelChart" style="max-height: 400px;"></canvas></div>
        </div>
    </div>
    <div class="col-lg-6">
        <div class="card shadow-sm h-100 p-4">
            <div class="card-body"><h2 class="card-title text-center mb-4 text-secondary">年度入住热力图</h2><div id="cal-heatmap" class="w-100"></div></div>
        </div>
    </div>
</section>

<section class="card shadow-sm mb-5 p-4" id="detailedRecordsSection" style="display: none;"><div class="card-body"><h2 class="card-title text-center mb-4 text-secondary">详细记录</h2><div class="table-responsive"><table class="table table-hover table-bordered"><thead><tr><th>预订号</th><th>日期</th><th>类型</th><th>房型</th><th>入住日期</th><th>退房日期</th><th>渠道</th><th>在线/离线</th><th>人数</th><th>天数</th><th>价格</th><th>打扫费</th><th>平台费</th><th>总收入</th><th>额外支出类别</th><th>额外支出金额</th>{% if current_user.role == 'admin' %}<th>操作</th>{% endif %}</tr></thead><tbody id="dataRows"></tbody></table></div></div></section>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const yearSelect = document.getElementById('yearSelect');
    const compareYearSelect = document.getElementById('compareYearSelect');
    const roomTypeSelect = document.getElementById('roomTypeSelect');
    const applyFiltersButton = document.getElementById('applyFiltersButton');
    const loadingOverlay = document.getElementById('loading-overlay');
    
    let comparisonChart, channelChart;
    const cal = new CalHeatmap();

    function updateDashboard() {
        if (loadingOverlay) loadingOverlay.style.display = 'flex';

        const year = yearSelect.value;
        const compareYear = compareYearSelect.value;
        const roomType = roomTypeSelect.value;

        const chartParams = new URLSearchParams({ year, room_type: roomType, compare_year: compareYear }).toString();
        const channelParams = new URLSearchParams({ year }).toString();
        const heatmapParams = new URLSearchParams({ year }).toString();

        const comparisonPromise = fetch(`/api/chart_data?${chartParams}`).then(res => res.json());
        const channelPromise = fetch(`/api/revenue_by_channel?${channelParams}`).then(res => res.json());
        const heatmapPromise = fetch(`/api/booking_heatmap?${heatmapParams}`).then(res => res.json());

        Promise.all([comparisonPromise, channelPromise, heatmapPromise])
            .then(([comparisonData, channelData, heatmapData]) => {
                renderComparisonChart(comparisonData);
                renderChannelChart(channelData);
                renderHeatmap(heatmapData, year);
            })
            .catch(error => {
                console.error('Error fetching data:', error);
                alert('仪表盘数据加载失败，请稍后重试。');
            })
            .finally(() => {
                if (loadingOverlay) loadingOverlay.style.display = 'none';
            });
    }

    function renderComparisonChart(data) {
        const ctx = document.getElementById('comparisonChart').getContext('2d');
        if (comparisonChart) comparisonChart.destroy();
        
        const datasets = [{
            label: `${data.main_year.year} 收入`,
            data: data.main_year.revenue,
            backgroundColor: 'rgba(25, 135, 84, 0.6)',
            borderColor: 'rgba(25, 135, 84, 1)',
            borderWidth: 1,
            type: 'bar'
        }, {
            label: `${data.main_year.year} 支出`,
            data: data.main_year.expenses,
            backgroundColor: 'rgba(220, 53, 69, 0.6)',
            borderColor: 'rgba(220, 53, 69, 1)',
            borderWidth: 1,
            type: 'bar'
        }];

        if (data.compare_year) {
            datasets.push({
                label: `${data.compare_year.year} 收入`,
                data: data.compare_year.revenue,
                borderColor: 'rgba(255, 159, 64, 1)',
                backgroundColor: 'rgba(255, 159, 64, 0.2)',
                borderWidth: 2,
                type: 'line',
                tension: 0.2
            });
        }

        comparisonChart = new Chart(ctx, {
            type: 'bar',
            data: { labels: data.months, datasets: datasets },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
        });
    }

    function renderChannelChart(data) {
        const ctx = document.getElementById('channelChart').getContext('2d');
        if (channelChart) channelChart.destroy();
        channelChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: data.labels,
                datasets: [{
                    label: '收入',
                    data: data.values,
                    backgroundColor: ['#28a745', '#ffc107', '#007bff', '#dc3545', '#6c757d', '#17a2b8'],
                }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });
    }

    function renderHeatmap(data, year) {
        cal.paint({
            data: { source: data, type: 'json' },
            date: { start: new Date(`${year}-01-01`) },
            range: 12,
            scale: {
                color: {
                    type: 'threshold',
                    range: ['#c6e48b', '#7bc96f', '#239a3b', '#196127'],
                    domain: [1, 3, 5, 10],
                },
            },
            domain: { type: 'month' },
            subDomain: { type: 'day', radius: 2 },
        }, [
            [
                CalHeatmap.Tooltip,
                { text: (date, value) => (value ? value : 'No') + ' bookings on ' + date.toDateString() },
            ],
        ]);
    }

    // Initial load
    updateDashboard();

    // Event listener
    applyFiltersButton.addEventListener('click', updateDashboard);
});
</script>
{% endblock %}




