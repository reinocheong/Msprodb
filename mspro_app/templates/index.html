{% extends "base.html" %}
{% block title %}民宿财务概览{% endblock %}

{% block content %}
<section class="card shadow-sm mb-5 p-4 bg-light-subtle">
    <div class="card-body">
        <h2 class="card-title text-center mb-4 text-secondary"><i class="fas fa-filter me-2"></i>筛选条件</h2>
        <div class="row g-3 align-items-end justify-content-center">
            <div class="col-md-3"><label for="yearSelect" class="form-label">年份:</label><select id="yearSelect" class="form-select">{% for year in years_options %}<option value="{{ year }}" {% if year|string == default_year %}selected{% endif %}>{{ year }}</option>{% endfor %}</select></div>
            <div class="col-md-3"><label for="monthSelect" class="form-label">月份:</label><select id="monthSelect" class="form-select"><option value="">所有月份</option>{% for month in months_options %}<option value="{{ month.value }}">{{ month.text }}</option>{% endfor %}</select></div>
            <div class="col-md-3"><label for="roomTypeSelect" class="form-label">房型:</label><select id="roomTypeSelect" class="form-select">{% for room_type in room_types %}<option value="{{ room_type }}">{{ room_type }}</option>{% endfor %}</select></div>
            <div class="col-md-3 d-grid"><button id="applyFiltersButton" class="btn btn-primary"><i class="fas fa-filter me-2"></i>应用筛选</button></div>
        </div>
        <div class="row g-3 justify-content-center mt-3">
            <div class="col-md-4 d-grid"><button id="toggleDetailedRecordsButton" class="btn btn-outline-secondary"><i class="fas fa-eye me-2"></i>查看详细</button></div>
            <div class="col-md-4 d-grid"><button id="downloadPdfButton" class="btn btn-outline-info"><i class="fas fa-download me-2"></i>下载月结单</button></div>
            {% if current_user.role == 'admin' %}<div class="col-md-4 d-grid"><a href="{{ url_for('main.add_booking') }}" class="btn btn-success"><i class="fas fa-plus-circle me-2"></i>新增预订</a></div>{% endif %}
        </div>
    </div>
</section>

<section class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4 mb-5 summary-cards">
    <div class="col"><div class="card h-100 shadow-sm" data-card-type="revenue"><div class="card-body text-center"><h5 class="card-title text-muted">预订收入</h5><p id="totalBookingRevenue" class="card-text">0.00</p></div></div></div>
    <div class="col"><div class="card h-100 shadow-sm" data-card-type="expenses"><div class="card-body text-center"><h5 class="card-title text-muted">月支出</h5><p id="totalMonthlyExpenses" class="card-text">0.00</p></div></div></div>
    <div class="col"><div class="card h-100 shadow-sm" data-card-type="profit"><div class="card-body text-center"><h5 class="card-title text-muted">毛利</h5><p id="grossProfit" class="card-text">0.00</p></div></div></div>
    <div class="col"><div class="card h-100 shadow-sm" data-card-type="fee"><div class="card-body text-center"><h5 class="card-title text-muted">管理费 (30%)</h5><p id="managementFee" class="card-text">0.00</p></div></div></div>
    <div class="col"><div class="card h-100 shadow-sm" data-card-type="income"><div class="card-body text-center"><h5 class="card-title text-muted">当月收入</h5><p id="monthlyIncome" class="card-text">0.00</p></div></div></div>
    <div class="col"><div class="card h-100 shadow-sm" data-card-type="occupancy"><div class="card-body text-center"><h5 class="card-title text-muted">入住率</h5><p id="totalOccupancyRate" class="card-text">0.00%</p></div></div></div>
</section>

<section class="card shadow-sm mb-5 p-4"><div class="card-body"><h2 class="card-title text-center mb-4 text-secondary">月度收支概览</h2><canvas id="monthlyChart" class="w-100" style="max-height: 400px;"></canvas></div></section>

<section class="card shadow-sm mb-5 p-4" id="detailedRecordsSection" style="display: none;"><div class="card-body"><h2 class="card-title text-center mb-4 text-secondary">详细记录</h2><div class="table-responsive"><table class="table table-hover table-bordered"><thead><tr><th>预订号</th><th>日期</th><th>类型</th><th>房型</th><th>入住日期</th><th>退房日期</th><th>渠道</th><th>在线/离线</th><th>人数</th><th>天数</th><th>价格</th><th>打扫费</th><th>平台费</th><th>总收入</th><th>额外支出类别</th><th>额外支出金额</th>{% if current_user.role == 'admin' %}<th>操作</th>{% endif %}</tr></thead><tbody id="dataRows"></tbody></table></div></div></section>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const yearSelect = document.getElementById('yearSelect');
    const monthSelect = document.getElementById('monthSelect');
    const roomTypeSelect = document.getElementById('roomTypeSelect');
    const applyFiltersButton = document.getElementById('applyFiltersButton');
    const downloadPdfButton = document.getElementById('downloadPdfButton');
    const toggleDetailedRecordsButton = document.getElementById('toggleDetailedRecordsButton');
    const detailedRecordsSection = document.getElementById('detailedRecordsSection');
    const dataRows = document.getElementById('dataRows');
    const loadingOverlay = document.getElementById('loading-overlay');
    
    let monthlyChart = null; // To hold the chart instance

    function updateDashboard(year, month, roomType) {
        if (loadingOverlay) loadingOverlay.style.display = 'flex';

        const filterParams = new URLSearchParams({ year, month, room_type: roomType }).toString();
        const chartParams = new URLSearchParams({ year, room_type: roomType }).toString();

        const summaryPromise = fetch(`/api/filter_data?${filterParams}`).then(res => res.json());
        const chartPromise = fetch(`/api/chart_data?${chartParams}`).then(res => res.json());

        Promise.all([summaryPromise, chartPromise])
            .then(([summaryRes, chartRes]) => {
                if (summaryRes.error || chartRes.error) {
                    throw new Error(summaryRes.error || chartRes.error);
                }

                const summary = summaryRes.summary;
                document.getElementById('totalBookingRevenue').textContent = (summary.total_booking_revenue || 0).toLocaleString('en-US', { style: 'currency', currency: 'MYR' });
                document.getElementById('totalMonthlyExpenses').textContent = (summary.total_monthly_expenses || 0).toLocaleString('en-US', { style: 'currency', currency: 'MYR' });
                document.getElementById('grossProfit').textContent = (summary.gross_profit || 0).toLocaleString('en-US', { style: 'currency', currency: 'MYR' });
                document.getElementById('managementFee').textContent = (summary.management_fee || 0).toLocaleString('en-US', { style: 'currency', currency: 'MYR' });
                document.getElementById('monthlyIncome').textContent = (summary.monthly_income || 0).toLocaleString('en-US', { style: 'currency', currency: 'MYR' });
                document.getElementById('totalOccupancyRate').textContent = `${(summary.total_occupancy_rate || 0).toFixed(2)}%`;

                const ctx = document.getElementById('monthlyChart').getContext('2d');
                if (monthlyChart) {
                    monthlyChart.destroy();
                }
                monthlyChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: chartRes.months,
                        datasets: [{
                            label: '月度总收入',
                            data: chartRes.monthly_revenue,
                            backgroundColor: 'rgba(25, 135, 84, 0.6)',
                            borderColor: 'rgba(25, 135, 84, 1)',
                            borderWidth: 1
                        }, {
                            label: '月度总支出',
                            data: chartRes.monthly_expenses,
                            backgroundColor: 'rgba(220, 53, 69, 0.6)',
                            borderColor: 'rgba(220, 53, 69, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: { y: { beginAtZero: true, ticks: { callback: value => 'RM ' + value.toLocaleString() } } },
                        plugins: { tooltip: { callbacks: { label: context => ` ${context.dataset.label}: RM ${context.parsed.y.toLocaleString()}` } } }
                    }
                });
            })
            .catch(error => {
                console.error('Error fetching data:', error);
                const container = document.querySelector('.container');
                if (container) {
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'alert alert-danger';
                    errorDiv.textContent = '数据加载失败，请稍后重试。';
                    container.prepend(errorDiv);
                }
            })
            .finally(() => {
                if (loadingOverlay) loadingOverlay.style.display = 'none';
            });
    }

    function fetchAndDisplayDetailedRecords() {
        const year = yearSelect.value;
        const month = monthSelect.value;
        const roomType = roomTypeSelect.value;
        const params = new URLSearchParams({ year, month, room_type: roomType }).toString();

        fetch(`/api/detailed_data?${params}`)
            .then(res => res.json())
            .then(res => {
                if (res.error) throw new Error(res.error);
                dataRows.innerHTML = ''; // Clear existing rows
                res.data.forEach(item => {
                    const row = `
                        <tr>
                            <td>${item.booking_number || '-'}</td>
                            <td>${item.date}</td>
                            <td><span class="badge bg-${item.type === 'booking' ? 'success' : 'danger'}">${item.type}</span></td>
                            <td>${item.unit_name}</td>
                            <td>${item.checkin}</td>
                            <td>${item.checkout}</td>
                            <td>${item.channel}</td>
                            <td>${item.on_offline}</td>
                            <td>${item.pax || '-'}</td>
                            <td>${item.duration || '-'}</td>
                            <td>${(item.price || 0).toFixed(2)}</td>
                            <td>${(item.cleaning_fee || 0).toFixed(2)}</td>
                            <td>${(item.platform_charge || 0).toFixed(2)}</td>
                            <td>${(item.total_booking_revenue || 0).toFixed(2)}</td>
                            <td>${item.additional_expense_category || '-'}</td>
                            <td>${(item.additional_expense_amount || 0).toFixed(2)}</td>
                            ${ "{% if current_user.role == 'admin' %}" }
                            <td>
                                ${item.type === 'booking' ? `<a href="/edit_booking/${item.id}" class="btn btn-sm btn-outline-primary">编辑</a>` : ''}
                                ${item.type === 'expense' ? `<a href="/edit_expense/${item.id}" class="btn btn-sm btn-outline-warning">编辑</a>` : ''}
                            </td>
                            ${ "{% endif %}" }
                        </tr>
                    `;
                    dataRows.insertAdjacentHTML('beforeend', row);
                });
                detailedRecordsSection.style.display = 'block';
            })
            .catch(error => console.error('Error fetching detailed data:', error));
    }

    // Initial load
    updateDashboard(yearSelect.value, monthSelect.value, roomTypeSelect.value);

    // Event listeners
    applyFiltersButton.addEventListener('click', () => updateDashboard(yearSelect.value, monthSelect.value, roomTypeSelect.value));

    downloadPdfButton.addEventListener('click', function() {
        const year = yearSelect.value;
        const month = monthSelect.value;
        const roomType = roomTypeSelect.value;
        if (!month) {
            alert('请选择一个月份来生成月结单。');
            return;
        }
        const params = new URLSearchParams({ year, month, room_type: roomType }).toString();
        window.location.href = `/download_monthly_statement?${params}`;
    });

    toggleDetailedRecordsButton.addEventListener('click', function() {
        if (detailedRecordsSection.style.display === 'none') {
            fetchAndDisplayDetailedRecords();
            this.innerHTML = '<i class="fas fa-eye-slash me-2"></i>隐藏详细';
            this.classList.remove('btn-outline-secondary');
            this.classList.add('btn-secondary');
        } else {
            detailedRecordsSection.style.display = 'none';
            this.innerHTML = '<i class="fas fa-eye me-2"></i>查看详细';
            this.classList.remove('btn-secondary');
            this.classList.add('btn-outline-secondary');
        }
    });
});
</script>
{% endblock %}



